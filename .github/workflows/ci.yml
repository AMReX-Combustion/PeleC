name: PeleC-CI

on:
  push:
    branches: [cpp]
  pull_request:
    branches: [cpp]

env:
  CXX_COMPILER: mpicxx
  C_COMPILER: mpicc
  FORTRAN_COMPILER: mpifort
  BUILD_TYPE: RelWithDebInfo
  NUM_PROCS: 16

jobs:
  build:
    runs-on: ${{matrix.os}}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: macos-latest
            install_deps: brew install open-mpi
            comp: llvm
          - os: ubuntu-latest
            install_deps: sudo apt-get install mpich libmpich-dev
            comp: gnu
    steps:
    - uses: actions/checkout@v2
      with: 
        submodules: true
    - name: dependencies
      run: |
        ${{matrix.install_deps}}
        cmake -E make_directory ${{runner.workspace}}/deps
        cd ${{runner.workspace}}/deps
        git clone --recursive https://github.com/roystgnr/MetaPhysicL.git ${{runner.workspace}}/deps/MetaPhysicL
        git clone --recursive https://github.com/manufactured-solutions/MASA.git ${{runner.workspace}}/deps/MASA
        cd ${{runner.workspace}}/deps/MetaPhysicL
        ./bootstrap
        mkdir build
        cd build
        ../configure --prefix="${{runner.workspace}}/deps/install/MetaPhysicL"
        make -j ${{env.NUM_PROCS}}
        make install
        cd ${{runner.workspace}}/deps/MASA
        ./bootstrap
        ./configure --enable-fortran-interfaces METAPHYSICL_DIR="${{runner.workspace}}/deps/install/MetaPhysicL" --prefix="${{runner.workspace}}/deps/install/MASA"
        make -j ${{env.NUM_PROCS}}
        make install
    - name: setup
      run: cmake -E make_directory ${{runner.workspace}}/build-ci
    - name: configure
      working-directory: ${{runner.workspace}}/build-ci
      run: |
        cmake \
          -DCMAKE_INSTALL_PREFIX:PATH=${{runner.workspace}}/install \
          -DCMAKE_BUILD_TYPE:STRING=${{env.BUILD_TYPE}} \
          -DCMAKE_CXX_COMPILER:STRING=${{env.CXX_COMPILER}} \
          -DCMAKE_C_COMPILER:STRING=${{env.C_COMPILER}} \
          -DCMAKE_Fortran_COMPILER:STRING=${{env.FORTRAN_COMPILER}} \
          -DPELEC_ENABLE_MPI:BOOL=ON \
          -DPELEC_ENABLE_TESTS:BOOL=ON \
          -DPELEC_ENABLE_FCOMPARE_FOR_TESTS:BOOL=OFF \
          -DMASA_DIR:STRING=${{runner.workspace}}/deps/install/MASA \
          -DPELEC_USE_CPP:BOOL=ON \
          ${GITHUB_WORKSPACE}
    - name: make
      working-directory: ${{runner.workspace}}/build-ci
      run: cmake --build . -- -j ${{env.NUM_PROCS}}
    - name: test
      working-directory: ${{runner.workspace}}/build-ci
      run: ctest -j ${{env.NUM_PROCS}} -LE no_ci --output-on-failure
    - name: gnumake-pmf
      working-directory: ./ExecCpp/RegTests/PMF
      run: make -j ${{env.NUM_PROCS}} COMP=${{matrix.comp}} USE_MPI=TRUE
